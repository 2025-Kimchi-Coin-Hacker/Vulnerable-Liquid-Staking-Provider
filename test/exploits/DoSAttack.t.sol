// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import {Test, console} from "forge-std/Test.sol";
import {StakingManager} from "../../src/core/StakingManager.sol";
import {LSToken} from "../../src/core/LSToken.sol";
import {ValidatorRegistry} from "../../src/core/ValidatorRegistry.sol";
import {RewardDistributor} from "../../src/rewards/RewardDistributor.sol";
import {AccessManager} from "../../src/access/AccessManager.sol";

contract DoSAttack is Test {
    StakingManager public stakingManager;
    ValidatorRegistry public validatorRegistry;
    AccessManager public accessManager;

    address public admin = makeAddr("admin");
    address public user = makeAddr("user");

    function setUp() public {
        vm.startPrank(admin);
        accessManager = new AccessManager(admin);
        LSToken lsToken = new LSToken(address(accessManager));
        validatorRegistry = new ValidatorRegistry(address(accessManager));
        RewardDistributor rewardDistributor = new RewardDistributor();
        stakingManager = new StakingManager(address(lsToken), address(validatorRegistry));

        accessManager.grantRole(accessManager.MINTER_ROLE(), address(stakingManager));
        accessManager.grantRole(accessManager.BURNER_ROLE(), address(stakingManager));
        vm.stopPrank();

        vm.deal(user, 10 ether);
    }

    function testDoSAttack() public {
        uint256 validatorCount = 2000;
        console.log("Registering validators : ", validatorCount);

        for (uint256 i = 0; i < validatorCount; i++) {
            validatorRegistry.addValidator(address(this), bytes(""));
        }

        vm.startPrank(user);
        uint256 startGas = gasleft();

        stakingManager.stake{value: 1 ether}();

        uint256 gasUsed = startGas - gasleft();
        console.log("Gas used for stake():", gasUsed);

        vm.stopPrank();
    }
}
